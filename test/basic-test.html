<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>

    <!-- Step 1: import the element to test -->
    <link rel="import" href="../stone-cart.html">
  </head>
  <body>

    <test-fixture id="EmptyCart">
      <template>
        <stone-cart></stone-cart>
      </template>
    </test-fixture>

    <test-fixture id="CartWithItems">
      <template>
        <stone-cart items='[{"id":1,"price":10},{"id":2,"price":5}]'></stone-cart>
      </template>
    </test-fixture>

    <script>
      suite('<stone-cart>', function() {
        var cart;

        suite('when the cart is empty', function() {
          setup(function() {
            cart = fixture('EmptyCart');
          });

          test('disables the cart', function() {
            expect(cart.hasAttribute('disabled')).to.equal(true);
          });
        });

        suite('when defining items for the empty cart', function() {
          var items = [{id: 1, price: 5}];

          setup(function() {
            cart = fixture('EmptyCart');
          });

          test('calculates the total price', function() {
            cart.items = items;

            expect(cart.total).to.equal(5);
          });

          test('enables the cart', function() {
            cart.items = items;

            expect(cart.hasAttribute('disabled')).to.equal(false);
          });

          test('fires the "reset" event', function() {
            return new Promise(function(resolve, reject) {
              cart.addEventListener('reset', function(e) {
                resolve();
              });

              cart.items = items;
            });
          });
        });

        suite('when adding a new item', function() {
          var newItem = {id: 3, price: 5};

          setup(function() {
            cart = fixture('CartWithItems');
          });

          test('the item gets added to the cart', function() {
            cart.addItem(newItem);

            expect(cart.items.length).to.equal(3);
            expect(cart.hasItem(newItem)).to.equal(true);
          });

          test('recalculates the total price', function() {
            cart.addItem(newItem);

            expect(cart.total).to.equal(20);
          });

          test('fires the "change" event', function() {
            return new Promise(function(resolve, reject) {
              cart.addEventListener('change', function(e) {
                var resp = e.detail;

                expect(resp.item).to.equal(newItem);
                expect(resp.action).to.equal('add');

                resolve();
              });

              cart.addItem(newItem);
            });
          });
        });

        suite('when removing the item from the cart', function() {
          var itemToBeRemoved = {id: 2};

          setup(function() {
            cart = fixture('CartWithItems');
          });

          test('the removed item is not in the cart anymore', function() {
            cart.removeItem(itemToBeRemoved);

            expect(cart.items.length).to.equal(1);
            expect(cart.hasItem(itemToBeRemoved)).to.equal(false);
          });

          test('recalculates the total price', function() {
            cart.removeItem(itemToBeRemoved);

            expect(cart.total).to.be.eql(10);
          });

          test('fires the "change" event', function() {
            return new Promise(function(resolve, reject) {
              cart.addEventListener('change', function(e) {
                var resp = e.detail;

                expect(resp.item).to.equal(itemToBeRemoved);
                expect(resp.action).to.equal('remove');

                resolve();
              });

              cart.removeItem(itemToBeRemoved);
            });
          });

        });
      });
    </script>
  </body>
</html>
