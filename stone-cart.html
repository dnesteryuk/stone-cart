<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="elements/stone-cart-add-btn.html">
<link rel="import" href="elements/stone-cart-remove-btn.html">

<!--
It is an element providing a common logic for adding items to a shopping cart and managing them within a shopping cart.

Example:

    <stone-cart items="{{items}}">
      Total price: [[total]]

      <template id="items" is="dom-repeat" items="{{items}}">
        [[item.name]] $[[item.price]]

        <stone-cart-remove-btn item="{{item}}">
          <button>Remove from my cart</button>
        </stone-cart-remove-btn>

      </template>
    </stone-cart>

    <stone-cart-add-btn item='{"id": 1, "name": "Apple", "price": "1"}'>
      <button>Add apple to my cart</button>
    </stone-cart-add-btn>

This element fires 2 types of events:

 - add-item - a new item is added to the cart.
 - remove-item - an item is removed from the cart.

Example:

    <script>
      var cart = document.querySelector('stone-cart');

      car.addEventListener('add-item', function(e) {
        e.detail.item // an added item to the cart
      });

      car.addEventListener('remove-item', function(e) {
        e.detail.item // a removed item from the cart
      });
    </script>

@demo demo/index.html
-->

<dom-module id="stone-cart">
  <template>
    <style>
      :host {
      }
    </style>

    <content></content>
  </template>

  <script>
    Polymer({
      is: 'stone-cart',

      properties: {
        /**
         * List of items in the cart.
         * Each item has to have the id and price properties. Other properties
         * can be used without any restrictions.
         *
         * Example:
         *
         *     [{
         *       id: 1,
         *       price: 10,
         *       name: 'Book',
         *       img_src: '/images/book.png'
         *     }]
         */
        items: {
          type:   Object,
          notify: true,
          value:  function() { return []; }
        },

        /**
         * Total price of items in the cart.
         */
        total: {
          type:     Number,
          notify:   true,
          readOnly: true,
          computed: '_computeTotal(items, items.length)',
          value:    0
        },

        /**
         * When a cart is empty, this property is true. This property
         * is used as an attribute of the element.
         *
         * Example:
         *
         *     <stone-cart disabled></stone-cart>
         */
        disabled: {
          type:               Boolean,
          value:              true,
          reflectToAttribute: true
        }
      },

      observers: [
        '_updateState(items, items.length)'
      ],

      ready: function() {
        // Cache of cart buttons
        this._btns = {
          add:    {},
          remove: {}
        };
      },

      /**
       * Adds a new item to the cart.
       */
      addItem: function(item) {
        this.push('items', item);

        this.fire('add-item', {item: item});
      },

      /**
       * Removes an item from the cart.
       */
      removeItem: function(item) {
        var index = this.items.indexOf(item);
        this.splice('items', index, 1);

        this.fire('remove-item', {item: item});
      },

      /**
       * Returns an Array of nodes representing the add buttons of a certain item.
       */
      allAddBtnsOf: function(itemId) {
        return this._btns.add[itemId];
      },

      /**
       * Returns an Array of nodes representing the remove buttons of a certain item.
       */
      allRemoveBtnsOf: function(itemId) {
        return this._btns.remove[itemId];
      },

      /**
       * Registers a cart button related to a certain item.
       * Registration happens automatically for the add and remove buttons.
       *
       * Example:
       *
       *     <stone-cart-add-btn></stone-cart-add-btn>
       *     <stone-cart-remove-btn></stone-cart-remove-btn>
       *
       * These buttons will be automatically registered.
       */
      registerBtn: function(kind, itemId, btn) {
        var scope = this._btnsOf(kind, itemId);

        scope.push(btn);
      },

      /**
       * Unregisters a cart button related to a certain item.
       * Unregistration happens automatically for the add and remove buttons.
       */
      unregisterBtn: function(kind, itemId, btn) {
        var scope = this._btnsOf(kind, itemId);
        var index = scope.indexOf(btn);

        scope.splice(index, 1);
      },

      _computeTotal: function(items) {
        return items.reduce(function(total, item) {
          return total + item.price;
        }, 0);
      },

      _updateState: function(count) {
        this.set('disabled', (count == 0));
      },

      _btnsOf: function(kind, itemId) {
        var scope = this._btns[kind];
        scope[itemId] = (scope[itemId] || []);
        return scope[itemId];
      }
    });
  </script>
</dom-module>
